# language: zh-TW
Feature: Video Preview Node
  作為 使用者
  我希望 可以透過影片預覽當前編輯的音效
  以便 判斷音效的時間長度是否適合

  Background:
    假設 我已經開啟音效處理工具
    而且 我已經建立一個圖形工作流

  # 節點基本功能

  Scenario: 建立影片預覽節點
    當 我從節點面板拖拉「影片預覽」節點到畫布
    那麼 我應該看到一個新的影片預覽節點
    而且 節點應該顯示「等待輸入」提示
    而且 「開啟編輯器」按鈕應該是禁用狀態

  Scenario: 載入影片檔案
    假設 我已經建立一個影片預覽節點
    當 我點擊「選擇影片檔案」按鈕
    而且 我選擇一個有效的影片檔案
    那麼 節點應該顯示影片縮圖預覽
    而且 節點應該顯示清除按鈕（×）
    而且 由於沒有輸入音訊，「開啟編輯器」按鈕應該可用（可預覽影片）

  Scenario: 透過拖放載入影片
    假設 我已經建立一個影片預覽節點
    當 我拖放一個影片檔案到節點上
    那麼 節點應該載入該影片並顯示縮圖

  Scenario: 清除已載入的影片
    假設 我已經載入一個影片到節點
    當 我點擊清除按鈕（×）
    那麼 影片應該被清除
    而且 節點應該回到未載入狀態

  Scenario: 載入非影片檔案
    假設 我已經建立一個影片預覽節點
    當 我嘗試載入一個非影片格式的檔案
    那麼 我應該看到錯誤提示「請選擇有效的影片檔案」
    而且 節點狀態不應該改變

  # 節點輸入輸出

  Scenario: 連接音訊輸入
    假設 我已經建立一個音訊輸入節點並載入音訊
    而且 我已經建立一個影片預覽節點
    當 我將音訊輸入節點的輸出連接到影片預覽節點的輸入
    那麼 影片預覽節點應該接收音訊列表
    而且 如果已載入影片，「開啟編輯器」按鈕應該可用

  Scenario: 有音訊輸入但無影片時的狀態
    假設 我已經連接音訊到影片預覽節點
    但是 我尚未載入影片
    那麼 節點應該顯示影片上傳區域
    而且 「開啟編輯器」按鈕應該是禁用狀態

  Scenario: 輸出處理後的音訊
    假設 我已經完成音訊編輯
    當 影片預覽節點執行處理
    那麼 節點應該在預覽區域顯示處理後的音訊列表
    而且 每個音訊應該有獨立的輸出端口
    而且 我可以將處理後的音訊連接到其他節點

  # 模態視窗基本操作

  Scenario: 開啟編輯器（僅影片）
    假設 我已經載入影片但沒有音訊輸入
    當 我點擊「開啟編輯器」按鈕
    那麼 應該顯示全螢幕模態視窗
    而且 我應該看到影片播放區域
    而且 我應該看到播放控制列
    而且 不應該顯示音軌區域

  Scenario: 開啟編輯器（完整編輯）
    假設 我已經載入影片和音訊輸入
    當 我點擊「開啟編輯器」按鈕
    那麼 應該顯示全螢幕模態視窗
    而且 我應該看到影片播放區域
    而且 我應該看到播放控制列
    而且 我應該看到與輸入音訊數量相同的音軌區域
    而且 每個音軌應該顯示檔案名稱和波形

  Scenario: 關閉編輯器
    假設 我已經開啟編輯器視窗
    當 我點擊關閉按鈕（×）
    那麼 模態視窗應該關閉
    而且 我應該回到節點圖視圖
    而且 所有編輯參數應該被保留

  # 時間軸與播放控制

  Scenario: 播放影片和音訊
    假設 我已經開啟編輯器並有音訊
    當 我點擊播放按鈕
    那麼 影片應該開始播放
    而且 所有音訊應該根據時間偏移同步播放
    而且 播放游標應該在時間軸上移動
    而且 時間顯示應該更新（精確到毫秒）

  Scenario: 暫停播放
    假設 影片和音訊正在播放中
    當 我點擊暫停按鈕
    那麼 影片和所有音訊應該暫停
    而且 播放游標應該停在當前位置

  Scenario: 拖動播放游標跳轉
    假設 我已經開啟編輯器
    當 我拖動播放游標到時間軸的某個位置
    那麼 影片應該跳轉到該時間點
    而且 如果正在播放，應該從該位置繼續播放

  Scenario: 點擊時間軸跳轉
    假設 我已經開啟編輯器
    當 我點擊時間軸上的某個位置
    那麼 播放游標應該移動到該位置
    而且 影片應該跳轉到該時間點

  Scenario: 影片結束後繼續播放音訊
    假設 影片長度為 5 秒
    而且 某個音訊延後到 3 秒開始播放，長度為 4 秒
    當 影片播放到結束（5 秒）
    那麼 影片應該停留在最後一幀
    而且 音訊應該繼續播放直到 7 秒

  # 音訊時間偏移編輯

  Scenario: 拖動音訊區塊調整時間偏移
    假設 我已經開啟編輯器並看到音軌
    當 我點擊音訊波形區塊的中間區域並拖動
    那麼 音訊區塊應該在時間軸上左右移動
    而且 我應該看到當前偏移時間的提示（例如：+2.350s）
    而且 音訊的播放時機應該根據偏移調整

  Scenario: 正偏移（延後播放）
    假設 我將音訊區塊向右拖動 2 秒
    當 我播放影片
    那麼 該音訊應該在影片播放 2 秒後才開始播放

  Scenario: 負偏移（提前播放 - 裁切效果）
    假設 我將音訊區塊向左拖動到時間軸起點之前
    當 我播放影片
    那麼 音訊應該從中間某個位置開始播放（開頭部分被跳過）

  Scenario: 音訊超出影片長度
    假設 影片長度為 5 秒
    當 我將音訊區塊拖動到 6 秒位置
    那麼 時間軸應該自動擴展以容納音訊
    而且 播放時影片停在最後一幀，音訊繼續播放

  # 音訊裁切編輯

  Scenario: 從左側裁切音訊開頭
    假設 我已經開啟編輯器並看到音軌
    當 我拖動音訊區塊的左側邊緣向右
    那麼 音訊區塊應該從左側縮短
    而且 右側位置應該保持不變
    而且 波形應該對應裁切後的部分
    而且 播放時應該跳過被裁切的開頭部分

  Scenario: 從右側裁切音訊結尾
    假設 我已經開啟編輯器並看到音軌
    當 我拖動音訊區塊的右側邊緣向左
    那麼 音訊區塊應該從右側縮短
    而且 左側位置應該保持不變
    而且 播放時應該在裁切點停止

  Scenario: 裁切的最小長度限制
    假設 我正在裁切音訊
    當 我嘗試將音訊裁切到小於 0.1 秒
    那麼 系統應該阻止進一步縮小
    而且 音訊區塊應該保持至少 0.1 秒長度

  Scenario: 波形顯示裁切部分
    假設 我已經裁切音訊的開頭和結尾
    那麼 波形應該顯示完整音訊
    而且 被裁切的部分應該以半透明顯示
    而且 可播放部分應該以正常顏色顯示

  # 同時編輯偏移和裁切

  Scenario: 先裁切再偏移
    假設 我有一個 10 秒的音訊
    當 我從兩側裁切到 5 秒長度
    而且 我將裁切後的音訊向右偏移 2 秒
    那麼 音訊應該從影片的第 2 秒開始播放
    而且 播放 5 秒後結束（在影片第 7 秒）

  Scenario: 先偏移再裁切
    假設 我將音訊向右偏移 3 秒
    當 我裁切音訊的開頭 2 秒
    那麼 音訊應該從影片的第 3 秒開始播放
    而且 播放的是原音訊從第 2 秒開始的內容

  # 多音軌編輯

  Scenario: 編輯多個音軌
    假設 我輸入了 3 個音訊檔案
    當 我開啟編輯器
    那麼 我應該看到 3 個音軌區域
    而且 我可以獨立調整每個音軌的偏移和裁切
    而且 播放時所有音軌應該同步播放

  Scenario: 音軌層疊播放
    假設 我有兩個音訊
    當 我設定音訊 1 從 0 秒開始播放
    而且 我設定音訊 2 從 2 秒開始播放
    而且 我播放影片
    那麼 0-2 秒只播放音訊 1
    而且 2 秒後兩個音訊同時播放

  # 資料處理與輸出

  Scenario: 處理時間偏移（正偏移）
    假設 我設定音訊偏移 +2 秒
    當 節點執行處理
    那麼 輸出的音訊應該在開頭添加 2 秒靜音
    而且 原始音訊內容應該跟在靜音之後

  Scenario: 處理時間偏移（負偏移）
    假設 我設定音訊偏移 -1 秒
    當 節點執行處理
    那麼 輸出的音訊應該裁切掉開頭 1 秒

  Scenario: 處理裁切
    假設 音訊長度為 10 秒
    當 我設定裁切範圍為 2-8 秒
    而且 節點執行處理
    那麼 輸出的音訊長度應該為 6 秒
    而且 內容應該對應原音訊的 2-8 秒部分

  Scenario: 同時處理裁切和偏移
    假設 音訊長度為 10 秒
    當 我設定裁切範圍為 2-8 秒（6 秒長度）
    而且 我設定偏移 +3 秒
    而且 節點執行處理
    那麼 輸出的音訊應該在開頭有 3 秒靜音
    而且 之後是原音訊的 2-8 秒內容（6 秒）
    而且 總長度應該為 9 秒

  # 資料持久化

  Scenario: 儲存工作流
    假設 我已經編輯了音軌的偏移和裁切
    當 我儲存工作流
    那麼 所有音軌的編輯參數應該被保存
    但是 影片檔案不應該被保存

  Scenario: 載入工作流
    假設 我之前儲存了包含影片預覽節點的工作流
    當 我載入該工作流
    那麼 音軌的編輯參數應該被還原
    但是 影片需要重新載入
    而且 節點應該顯示「未載入影片」狀態

  Scenario: 保持編輯參數一致性
    假設 我儲存時有 3 個音軌的編輯參數
    當 我載入工作流並連接了相同的 3 個音訊輸入
    那麼 每個音訊應該套用對應的編輯參數

  # 錯誤處理

  Scenario: 載入大型影片檔案
    假設 我選擇一個超過 100MB 的影片檔案
    當 影片開始載入
    那麼 我應該看到警告提示「檔案較大，可能影響效能」
    但是 系統仍然允許載入

  Scenario: 影片載入失敗
    假設 我選擇一個損壞的影片檔案
    當 系統嘗試載入影片
    那麼 我應該看到錯誤提示「影片載入失敗」
    而且 節點應該清除影片資料並回到未載入狀態

  Scenario: 大量音軌警告
    假設 我輸入了 15 個音訊檔案
    當 我開啟編輯器
    那麼 我應該看到警告提示「音軌數量較多，可能影響效能」
    但是 系統仍然顯示所有音軌

  # UI 互動細節

  Scenario: 游標變化提示操作類型
    假設 我已經開啟編輯器
    當 我將滑鼠移到音訊區塊中間
    那麼 游標應該變為「↔」（移動）
    當 我將滑鼠移到音訊區塊左側邊緣
    那麼 游標應該變為「◀」（裁切）
    當 我將滑鼠移到音訊區塊右側邊緣
    那麼 游標應該變為「▶」（裁切）

  Scenario: 拖動時顯示即時資訊
    假設 我正在拖動音訊區塊調整偏移
    那麼 我應該看到當前偏移值的提示（例如：+2.350s）
    當 我正在裁切音訊
    那麼 我應該看到當前音訊長度的提示

  Scenario: 時間軸自動擴展
    假設 初始時間軸長度為 5 秒（影片長度）
    當 我將音訊拖動到 7 秒位置
    那麼 時間軸應該自動擴展到至少 7 秒
    而且 時間刻度應該相應調整

  # 效能與記憶體管理

  Scenario: 關閉編輯器釋放資源
    假設 我已經開啟編輯器並載入了波形
    當 我關閉編輯器
    那麼 所有 WaveSurfer 實例應該被銷毀
    而且 所有 AudioBufferSourceNode 應該被停止
    而且 記憶體應該被釋放

  Scenario: 編輯器鎖定節點圖
    假設 我已經開啟編輯器
    那麼 我不應該能夠編輯節點圖
    而且 我不應該能夠修改節點連接
    而且 背景的節點圖應該處於鎖定狀態
