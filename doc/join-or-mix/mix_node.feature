# language: zh-TW
Feature: Mix Node（混音節點）
  作為 使用者
  我希望 可以將兩個音訊混合成一個音訊
  以便 將多軌音效疊加合成為單一音訊

  Background:
    Given 使用者已開啟音效編輯工具
    And 工具列中有「混音節點」可供新增

  # ============================================
  # Scenario 1: 建立混音節點
  # ============================================
  Scenario: 成功建立混音節點
    When 使用者從工具列拖拉或點擊新增「混音節點」
    Then 畫布上出現一個混音節點
    And 節點有 2 個輸入連接點（輸入1、輸入2）
    And 節點有 1 個輸出連接點
    And 輸入1 標示為「音軌1」
    And 輸入2 標示為「音軌2」

  # ============================================
  # Scenario 2: 連接音訊來源
  # ============================================
  Scenario: 連接兩個單一檔案音訊
    Given 使用者已建立一個混音節點
    And 使用者已建立兩個音訊輸入節點，各載入 1 個檔案
    When 使用者將第一個音訊輸入節點連接到輸入1
    And 使用者將第二個音訊輸入節點連接到輸入2
    Then 兩條連線成功建立
    And 節點顯示已連接 2 個來源

  Scenario: 連接處理節點的輸出
    Given 使用者已建立一個混音節點
    And 使用者已建立音訊輸入節點 → 音量調整節點的流程
    When 使用者將音量調整節點的輸出連接到混音節點的輸入
    Then 連線成功建立
    And 混音節點可接收處理過的音訊

  # ============================================
  # Scenario 3: 多檔案輸入限制
  # ============================================
  Scenario: 輸入1 連接多檔案來源時顯示警告
    Given 使用者已建立一個混音節點
    And 使用者已建立一個音訊輸入節點並載入 3 個檔案
    When 使用者將該音訊輸入節點連接到輸入1
    Then 顯示警告訊息「混音節點僅支援單一檔案輸入，請確保輸入來源只有一個檔案」
    And 連線仍可建立但節點標示為警告狀態

  Scenario: 輸入2 連接多檔案來源時顯示警告
    Given 使用者已建立一個混音節點
    And 使用者已建立一個音訊輸入節點並載入 2 個檔案
    When 使用者將該音訊輸入節點連接到輸入2
    Then 顯示警告訊息「混音節點僅支援單一檔案輸入，請確保輸入來源只有一個檔案」
    And 連線仍可建立但節點標示為警告狀態

  Scenario: 兩個輸入皆為多檔案來源時顯示警告
    Given 使用者已建立一個混音節點
    And 使用者已建立兩個音訊輸入節點，各載入多個檔案
    When 使用者將兩個音訊輸入節點分別連接到輸入1 和輸入2
    Then 顯示警告訊息「混音節點僅支援單一檔案輸入，請確保輸入來源只有一個檔案」
    And 節點標示為警告狀態
    And 無法產生輸出

  Scenario: 連接合併節點的多檔案輸出時顯示警告
    Given 使用者已建立一個混音節點
    And 使用者已建立一個合併節點並連接多個音訊來源
    When 使用者將合併節點的輸出連接到混音節點的輸入
    Then 顯示警告訊息「混音節點僅支援單一檔案輸入，請確保輸入來源只有一個檔案」
    And 連線仍可建立但節點標示為警告狀態

  # ============================================
  # Scenario 4: 音訊混合處理
  # ============================================
  Scenario: 成功混合兩個等長音訊
    Given 使用者已建立一個混音節點
    And 輸入1 已連接一個 5 秒的音訊
    And 輸入2 已連接一個 5 秒的音訊
    When 節點處理完成
    Then 輸出一個 5 秒的音訊
    And 輸出音訊為輸入1 與輸入2 的混合音訊

  Scenario: 混合不同長度的音訊
    Given 使用者已建立一個混音節點
    And 輸入1 已連接一個 3 秒的音訊
    And 輸入2 已連接一個 5 秒的音訊
    When 節點處理完成
    Then 輸出一個 5 秒的音訊（取較長者）
    And 輸出音訊的前 3 秒為兩個音訊的混合
    And 輸出音訊的後 2 秒僅有輸入2 的內容

  Scenario: 不同取樣率的音訊混合
    Given 使用者已建立一個混音節點
    And 輸入1 的音訊取樣率為 44100 Hz
    And 輸入2 的音訊取樣率為 48000 Hz
    When 節點處理完成
    Then 輸出音訊的取樣率統一為較高的 48000 Hz
    And 音訊內容正確混合

  Scenario: 不同聲道數的音訊混合
    Given 使用者已建立一個混音節點
    And 輸入1 為單聲道音訊
    And 輸入2 為立體聲音訊
    When 節點處理完成
    Then 輸出音訊為立體聲
    And 單聲道部分自動轉換為立體聲後混合

  # ============================================
  # Scenario 5: 音量平衡控制
  # ============================================
  Scenario: 調整混音音量比例
    Given 使用者已建立一個混音節點
    And 已連接兩個有效的單一檔案音訊來源
    Then 節點顯示音量平衡滑桿
    And 預設值為 50%（兩軌等量混合）

  Scenario: 調整音軌1 較大聲
    Given 使用者已建立一個混音節點
    And 已連接兩個有效的單一檔案音訊來源
    When 使用者將音量平衡滑桿調整至 75%
    Then 輸出音訊中音軌1 佔 75%
    And 輸出音訊中音軌2 佔 25%

  Scenario: 調整音軌2 較大聲
    Given 使用者已建立一個混音節點
    And 已連接兩個有效的單一檔案音訊來源
    When 使用者將音量平衡滑桿調整至 25%
    Then 輸出音訊中音軌1 佔 25%
    And 輸出音訊中音軌2 佔 75%

  Scenario: 僅保留音軌1
    Given 使用者已建立一個混音節點
    And 已連接兩個有效的單一檔案音訊來源
    When 使用者將音量平衡滑桿調整至 100%
    Then 輸出音訊僅包含音軌1 的內容
    And 音軌2 完全靜音

  Scenario: 僅保留音軌2
    Given 使用者已建立一個混音節點
    And 已連接兩個有效的單一檔案音訊來源
    When 使用者將音量平衡滑桿調整至 0%
    Then 輸出音訊僅包含音軌2 的內容
    And 音軌1 完全靜音

  # ============================================
  # Scenario 6: 預覽區域顯示
  # ============================================
  Scenario: 混音節點顯示預覽
    Given 使用者已建立一個混音節點
    And 已連接兩個有效的單一檔案音訊來源
    When 展開混音節點的預覽頁簽
    Then 顯示混合後的完整音訊波形圖
    And 顯示輸出音訊的總時長
    And 可播放預覽混合後的音訊

  Scenario: 預覽區域顯示雙軌波形
    Given 使用者已建立一個混音節點
    And 已連接兩個有效的單一檔案音訊來源
    When 展開預覽頁簽
    Then 可選擇顯示模式：混合波形 / 雙軌分離波形
    And 雙軌分離模式下，分別顯示音軌1 與音軌2 的波形

  # ============================================
  # Scenario 7: 輸出連接
  # ============================================
  Scenario: 混音節點連接到下游處理節點
    Given 使用者已建立一個混音節點
    And 混音節點已連接兩個有效的音訊來源
    When 使用者將混音節點的輸出連接到音量調整節點
    Then 連線成功建立
    And 音量調整節點接收到混合後的單一音訊
    And 音量調整節點顯示單一檔案預覽

  # ============================================
  # Scenario 8: 下載功能
  # ============================================
  Scenario: 下載混合後的音訊
    Given 使用者已建立一個混音節點
    And 混音節點已成功產生輸出
    When 按下「下載」按鈕
    Then 下載混合後的音訊檔案（WAV 格式）
    And 檔案名稱為「mixed_audio.wav」或使用者自訂名稱

  # ============================================
  # Scenario 9: 錯誤處理
  # ============================================
  Scenario: 只有輸入1 有連接時
    Given 使用者已建立一個混音節點
    And 僅輸入1 有連接音訊來源
    Then 節點顯示「請連接輸入2」提示
    And 輸出不產生任何資料

  Scenario: 只有輸入2 有連接時
    Given 使用者已建立一個混音節點
    And 僅輸入2 有連接音訊來源
    Then 節點顯示「請連接輸入1」提示
    And 輸出不產生任何資料

  Scenario: 兩個輸入皆未連接時
    Given 使用者已建立一個混音節點
    And 沒有任何輸入連接
    Then 節點顯示「請連接音訊來源」提示
    And 輸出不產生任何資料

  # ============================================
  # Scenario 10: 防止音訊削波
  # ============================================
  Scenario: 混音時自動標準化防止削波
    Given 使用者已建立一個混音節點
    And 已連接兩個音量較大的音訊來源
    When 節點處理完成
    Then 輸出音訊自動標準化
    And 不會產生音訊削波失真
    And 顯示「已自動調整音量防止削波」提示（如有調整）

  Scenario: 關閉自動標準化
    Given 使用者已建立一個混音節點
    And 已連接兩個有效的音訊來源
    When 使用者關閉「自動標準化」選項
    Then 混合後的音訊不會自動調整音量
    And 若發生削波，顯示警告訊息「音訊可能有削波失真」
