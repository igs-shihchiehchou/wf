# language: zh-TW
Feature: Volume Sync Node（音量整合節點）
  作為 使用者
  我希望 可以將多個音訊的音量統一調整到一致的最大真實峰值
  以便 播放多個遊戲音效時不會因音量大小差異過大而產生不適

  說明:
    - 本節點採用「真實峰值正規化 (True Peak Normalization)」，以音訊的最大真實峰值 (True Peak dBTP) 為基準進行調整
    - 相較於樣布峰值 (Sample Peak)，真實峰值能偵測並防止取樣點之間的削波失真 (Inter-sample Peaks)
    - 設定最大真實峰值確保音訊在轉碼或類比轉換時不會失真

  Background:
    Given 使用者已開啟音效編輯工具
    And 工具列中有「音量整合節點」可供新增

  # ============================================
  # Scenario 1: 建立音量整合節點
  # ============================================
  Scenario: 成功建立音量整合節點
    When 使用者從工具列拖拉或點擊新增「音量整合節點」
    Then 畫布上出現一個音量整合節點
    And 節點有 1 個輸入連接點
    And 節點有 1 個輸出連接點
    And 節點顯示「執行」按鈕
    And 節點顯示目標響度設定區域

  # ============================================
  # Scenario 2: 連接音訊來源
  # ============================================
  Scenario: 連接單一音訊輸入節點
    Given 使用者已建立一個音量整合節點
    And 使用者已建立一個音訊輸入節點並載入 1 個檔案
    When 使用者將音訊輸入節點的輸出連接到音量整合節點的輸入
    Then 連線成功建立
    And 音量整合節點顯示已連接 1 個來源

  Scenario: 連接多檔案音訊輸入節點
    Given 使用者已建立一個音量整合節點
    And 使用者已建立一個音訊輸入節點並載入 5 個檔案
    When 使用者將音訊輸入節點的輸出連接到音量整合節點的輸入
    Then 連線成功建立
    And 音量整合節點顯示已連接 5 個來源

  Scenario: 連接合併節點的輸出
    Given 使用者已建立一個音量整合節點
    And 使用者已建立一個合併節點並連接多個音訊來源（共 4 個檔案）
    When 使用者將合併節點的輸出連接到音量整合節點的輸入
    Then 連線成功建立
    And 音量整合節點顯示已連接 4 個來源

  Scenario: 連接處理節點的輸出
    Given 使用者已建立一個音量整合節點
    And 使用者已建立音訊輸入節點 → 音量調整節點的流程
    When 使用者將音量調整節點的輸出連接到音量整合節點的輸入
    Then 連線成功建立
    And 音量整合節點可接收處理過的音訊

  # ============================================
  # Scenario 3: 音量分析功能
  # ============================================
  Scenario: 節點顯示簡易真實峰值標籤
    Given 使用者已建立一個音量整合節點
    And 已連接多個音訊來源（共 3 個檔案）
    When 連線完成且分析完畢
    Then 節點上顯示一個簡易真實峰值標籤（Tag）
    And 標籤顯示最大真實峰值（如「TP: -1.0 dBTP」）
    And 標籤顯示峰值差異值（如「Δ 2.0 dB」）

  Scenario: 節點顯示詳細分析按鈕
    Given 使用者已建立一個音量整合節點
    And 已連接多個音訊來源
    Then 每個檔案項目旁顯示「⇋」分析按鈕
    And 按鈕初始狀態為「🔍」表示尚未展開詳細分析
    And 展開過詳細分析的檔案按鈕變為「⇋」

  Scenario: 點擊按鈕在節點內展開詳細分析面板
    Given 使用者已建立一個音量整合節點
    And 已連接多個音訊來源
    When 使用者點擊某檔案的「�」分析按鈕
    Then 節點內部展開該檔案的細部分析面板
    And 面板顯示該檔案的詳細音量資訊
    And 面板右上角顯示「×」關閉按鈕
    And 節點會自動調整高度以容納面板

  Scenario: 細部分析面板內容
    Given 使用者已建立一個音量整合節點
    And 已展開某檔案的細部分析面板
    Then 面板顯示檔案名稱
    And 面板顯示真實峰值（True Peak dBTP）- 主要指標
    And 面板顯示平均響度（LUFS）- 參考指標
    And 面板顯示響度範圍（LRA）
    And 面板顯示音量波形視覺化
    And 真實峰值以粗體或特殊顏色強調

  Scenario: 關閉細部分析面板
    Given 使用者已建立一個音量整合節點
    And 已展開某檔案的細部分析面板
    When 使用者點擊面板的「×」關閉按鈕
    Then 面板收縮並隱藏
    And 節點恢復原本高度

  Scenario: 細部分析面板顯示音量對照長條圖
    Given 使用者已建立一個音量整合節點
    And 已連接多個音訊來源
    When 使用者展開細部分析面板
    Then 面板顯示所有檔案的音量對照長條圖
    And 長條圖橫向顯示各檔案的相對音量
    And 以不同顏色標示音量過大（紅）或過小（藍）的檔案
    And 顯示音量摘要資訊（最大值、最小值、平均值、差異值）


  # ============================================
  # Scenario 4: 最大真實峰值設定
  # ============================================
  Scenario: 預設最大真實峰值
    Given 使用者已建立一個音量整合節點
    Then 預設最大真實峰值為 -1.0 dBTP（防止跨樣本削波的安全標準）

  Scenario: 使用預設峰值模式
    Given 使用者已建立一個音量整合節點
    Then 節點提供預設真實峰值模式選項
    And 選項包含「遊戲音效」模式（-1.0 dBTP）
    And 選項包含「影片配樂」模式（-2.0 dBTP）
    And 選項包含「廣播標準」模式（-1.0 dBTP / EBU R128）
    And 選項包含「自訂」模式

  Scenario: 自訂最大真實峰值
    Given 使用者已建立一個音量整合節點
    When 使用者選擇「自訂」模式
    Then 顯示真實峰值輸入欄位
    And 使用者可輸入目標真實峰值（-60 至 0 dBTP）

  Scenario: 使用滑桿調整最大真實峰值
    Given 使用者已建立一個音量整合節點
    And 使用者選擇「自訂」模式
    When 使用者拖曳峰值滑桿
    Then 目標真實峰值即時更新
    And 顯示預估調整後各檔案的增益/衰減量

  # ============================================
  # Scenario 5: 執行音量整合
  # ============================================
  Scenario: 按下執行按鈕開始整合
    Given 使用者已建立一個音量整合節點
    And 已連接多個音訊來源
    And 已設定目標響度
    When 使用者按下「執行」按鈕
    Then 顯示處理中狀態
    And 顯示處理進度條
    And 進度條顯示已處理的檔案數量

  Scenario: 成功完成音量整合
    Given 使用者已建立一個音量整合節點
    And 已連接多個音訊來源
    And 已按下「執行」按鈕
    When 處理完成
    When 處理完成
    Then 顯示「處理完成」提示
    And 所有輸出音訊的最大真實峰值統一為目標值
    And 輸出連接點可傳遞處理後的音訊

  Scenario: 音量整合保持相對音量關係
    Given 使用者已建立一個音量整合節點
    And 已連接多個音訊來源
    And 勾選「保持相對音量」選項
    When 使用者按下「執行」按鈕
    Then 所有檔案同比例調整音量
    And 原本較大聲的檔案處理後仍較大聲(相對關係不變)
    And 最大真實峰值的檔案調整至目標值，其餘同比例調整

  Scenario: 音量整合使用絕對峰值模式
    Given 使用者已建立一個音量整合節點
    And 已連接多個音訊來源
    And 未勾選「保持相對音量」選項
    When 使用者按下「執行」按鈕
    Then 每個檔案獨立調整至最大真實峰值
    And 處理後所有檔案的真實峰值完全一致

  # ============================================
  # Scenario 6: 預覽區域顯示
  # ============================================
  Scenario: 展開預覽頁簽
    Given 使用者已建立一個音量整合節點
    And 已連接多個音訊來源
    And 已完成音量整合處理
    When 展開音量整合節點的預覽頁簽
    Then 顯示處理後的多檔案預覽區域
    And 每個預覽區域顯示檔案名稱
    And 每個預覽區域顯示處理後的音訊波形圖
    And 每個預覽區域可獨立播放

  Scenario: 預覽區域顯示音量變化
    Given 使用者已建立一個音量整合節點
    And 已完成音量整合處理
    When 展開預覽頁簽
    Then 每個預覽區域顯示處理前後的音量變化
    And 顯示變化值（如「+3 dB」或「-5 dB」）
    And 以不同顏色標示增益或衰減

  Scenario: 多檔案預覽分頁功能
    Given 使用者已建立一個音量整合節點
    And 已連接超過 5 個音訊來源
    And 已完成音量整合處理
    When 展開預覽頁簽
    Then 預覽區域每頁最多顯示 5 個檔案
    And 顯示分頁資訊
    And 可透過分頁按鈕切換檢視

  Scenario: 預覽處理前後對比
    Given 使用者已建立一個音量整合節點
    And 已完成音量整合處理
    When 展開預覽頁簽
    Then 可切換顯示模式：處理前 / 處理後 / 對比
    And 對比模式下同時顯示處理前後的波形

  # ============================================
  # Scenario 7: 輸出連接
  # ============================================
  Scenario: 音量整合節點連接到下游處理節點
    Given 使用者已建立一個音量整合節點
    And 音量整合節點已完成處理
    When 使用者將音量整合節點的輸出連接到其他處理節點
    Then 連線成功建立
    And 下游節點接收到所有整合後的音訊檔案
    And 下游節點顯示多檔案預覽

  # ============================================
  # Scenario 8: 下載功能
  # ============================================
  Scenario: 下載全部處理後的檔案
    Given 使用者已建立一個音量整合節點
    And 音量整合節點已完成處理
    When 按下「下載全部」按鈕
    Then 所有處理後的音訊檔案被打包成 ZIP 壓縮檔
    And 自動下載該壓縮檔
    And 壓縮檔內的檔案保留原始檔名

  Scenario: 下載單一處理後的檔案
    Given 使用者已建立一個音量整合節點
    And 音量整合節點已完成處理
    When 按下單一檔案的「下載」按鈕
    Then 僅下載該處理後的檔案（WAV 格式）
    And 檔案名稱保留原始檔名

  # ============================================
  # Scenario 9: 限幅器防止削波
  # ============================================
  Scenario: 自動限幅防止音訊削波
    Given 使用者已建立一個音量整合節點
    And 已連接多個音訊來源
    And 目標真實峰值設定較高導致可能削波
    When 使用者按下「執行」按鈕
    Then 系統自動套用限幅器
    And 輸出音訊不會超過設定的最大真實峰值（預設 -1.0 dBTP）
    And 顯示「已自動限幅防止削波」提示

  Scenario: 關閉自動限幅
    Given 使用者已建立一個音量整合節點
    And 已連接多個音訊來源
    When 使用者關閉「自動限幅」選項
    And 使用者按下「執行」按鈕
    Then 音量調整不受限幅限制
    And 若發生削波，顯示警告訊息「音訊可能有削波失真」

  # ============================================
  # Scenario 10: 錯誤處理
  # ============================================
  Scenario: 沒有任何輸入時顯示提示
    Given 使用者已建立一個音量整合節點
    And 沒有任何輸入連接
    Then 節點顯示「請連接音訊來源」提示
    And 「執行」按鈕為禁用狀態

  Scenario: 只有一個輸入檔案時的處理
    Given 使用者已建立一個音量整合節點
    And 已連接 1 個音訊來源
    When 使用者按下「執行」按鈕
    Then 系統正常處理該檔案
    And 輸出音訊調整至最大真實峰值
    And 顯示「已完成音量調整」提示

  Scenario: 未按執行時禁止輸出
    Given 使用者已建立一個音量整合節點
    And 已連接多個音訊來源
    And 尚未按下「執行」按鈕
    Then 輸出連接點顯示為待處理狀態
    And 無法將輸出連接到下游節點
    And 顯示「請先按執行按鈕處理音訊」提示

  Scenario: 重新連接輸入後需重新執行
    Given 使用者已建立一個音量整合節點
    And 已完成音量整合處理
    When 使用者變更輸入連接（新增或移除音訊來源）
    Then 節點顯示「輸入已變更，請重新執行」提示
    And 之前的處理結果失效
    And 需重新按下「執行」按鈕
