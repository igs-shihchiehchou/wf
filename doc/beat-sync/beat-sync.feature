# language: zh-TW
Feature: Tempo Integration Node（節拍整合節點）
  作為 使用者
  我希望 可以將多個音訊的節拍統一調整到一致的 BPM
  以便 播放多個遊戲音效時節奏保持一致且不會因節拍差異而產生不協調感

  說明:
    - 本節點採用「時間伸縮 (Time Stretching)」技術，在改變音訊速度的同時保持音高不變
    - 自動偵測每個音訊檔案的 BPM（每分鐘節拍數）
    - 可設定目標 BPM，將所有音訊統一調整至該節拍
    - 支援保持相對節拍差異或統一為絕對節拍兩種模式

  Background:
    Given 使用者已開啟音效編輯工具
    And 工具列中有「節拍整合節點」可供新增

  # ============================================
  # Scenario 1: 建立節拍整合節點
  # ============================================
  Scenario: 成功建立節拍整合節點
    When 使用者從工具列拖拉或點擊新增「節拍整合節點」
    Then 畫布上出現一個節拍整合節點
    And 節點有 1 個輸入連接點
    And 節點有 1 個輸出連接點
    And 節點顯示「執行」按鈕
    And 節點顯示目標 BPM 設定區域

  # ============================================
  # Scenario 2: 連接音訊來源
  # ============================================
  Scenario: 連接單一音訊輸入節點
    Given 使用者已建立一個節拍整合節點
    And 使用者已建立一個音訊輸入節點並載入 1 個檔案
    When 使用者將音訊輸入節點的輸出連接到節拍整合節點的輸入
    Then 連線成功建立
    And 節拍整合節點顯示已連接 1 個來源

  Scenario: 連接多檔案音訊輸入節點
    Given 使用者已建立一個節拍整合節點
    And 使用者已建立一個音訊輸入節點並載入 5 個檔案
    When 使用者將音訊輸入節點的輸出連接到節拍整合節點的輸入
    Then 連線成功建立
    And 節拍整合節點顯示已連接 5 個來源

  Scenario: 連接合併節點的輸出
    Given 使用者已建立一個節拍整合節點
    And 使用者已建立一個合併節點並連接多個音訊來源（共 4 個檔案）
    When 使用者將合併節點的輸出連接到節拍整合節點的輸入
    Then 連線成功建立
    And 節拍整合節點顯示已連接 4 個來源

  Scenario: 連接處理節點的輸出
    Given 使用者已建立一個節拍整合節點
    And 使用者已建立音訊輸入節點 → 音量調整節點的流程
    When 使用者將音量調整節點的輸出連接到節拍整合節點的輸入
    Then 連線成功建立
    And 節拍整合節點可接收處理過的音訊

  # ============================================
  # Scenario 3: BPM 自動偵測與分析
  # ============================================
  Scenario: 自動偵測音訊 BPM
    Given 使用者已建立一個節拍整合節點
    And 已連接多個音訊來源（共 3 個檔案）
    When 連線完成
    Then 節點自動開始分析每個檔案的 BPM
    And 顯示分析進度條
    And 分析完成後顯示每個檔案的 BPM 值

  Scenario: 節點顯示簡易 BPM 標籤
    Given 使用者已建立一個節拍整合節點
    And 已連接多個音訊來源（共 3 個檔案）
    When BPM 分析完成
    Then 節點上顯示一個簡易 BPM 標籤（Tag）
    And 標籤顯示 BPM 範圍（如「BPM: 120-140」）
    And 標籤顯示 BPM 差異值（如「Δ 20 BPM」）

  Scenario: 節點顯示詳細分析按鈕
    Given 使用者已建立一個節拍整合節點
    And 已連接多個音訊來源
    Then 每個檔案項目旁顯示「⇋」分析按鈕
    And 按鈕初始狀態為「🔍」表示尚未展開詳細分析
    And 展開過詳細分析的檔案按鈕變為「⇋」

  Scenario: 點擊按鈕在節點內展開詳細分析面板
    Given 使用者已建立一個節拍整合節點
    And 已連接多個音訊來源
    When 使用者點擊某檔案的「🔍」分析按鈕
    Then 節點內部展開該檔案的細部分析面板
    And 面板顯示該檔案的詳細節拍資訊
    And 面板右上角顯示「×」關閉按鈕
    And 節點會自動調整高度以容納面板

  Scenario: 細部分析面板內容
    Given 使用者已建立一個節拍整合節點
    And 已展開某檔案的細部分析面板
    Then 面板顯示檔案名稱
    And 面板顯示偵測到的 BPM 值 - 主要指標
    And 面板顯示節拍信心度（Confidence）百分比
    And 面板顯示音訊時長
    And 面板顯示節拍波形視覺化（Beat Grid）
    And BPM 值以粗體或特殊顏色強調

  Scenario: 關閉細部分析面板
    Given 使用者已建立一個節拍整合節點
    And 已展開某檔案的細部分析面板
    When 使用者點擊面板的「×」關閉按鈕
    Then 面板收縮並隱藏
    And 節點恢復原本高度

  Scenario: 細部分析面板顯示 BPM 對照長條圖
    Given 使用者已建立一個節拍整合節點
    And 已連接多個音訊來源
    When 使用者展開細部分析面板
    Then 面板顯示所有檔案的 BPM 對照長條圖
    And 長條圖橫向顯示各檔案的相對 BPM
    And 以不同顏色標示 BPM 過快（紅）或過慢（藍）的檔案
    And 顯示 BPM 摘要資訊（最大值、最小值、平均值、差異值）

  # ============================================
  # Scenario 4: 手動修正 BPM
  # ============================================
  Scenario: 手動修正單一檔案的 BPM
    Given 使用者已建立一個節拍整合節點
    And 已完成 BPM 自動偵測
    And 某檔案的偵測 BPM 為 120
    When 使用者點擊該檔案的 BPM 值進入編輯模式
    And 使用者輸入新的 BPM 值 140
    Then BPM 值更新為 140
    And 顯示「已手動修正」標記
    And 重新計算該檔案需要的調整比例

  Scenario: BPM 倍數修正功能
    Given 使用者已建立一個節拍整合節點
    And 某檔案的偵測 BPM 為 70（可能是 140 的半速）
    When 使用者點擊 BPM 值旁的「×2」按鈕
    Then BPM 值更新為 140
    And 顯示「已倍數修正」標記

  Scenario: BPM 半速修正功能
    Given 使用者已建立一個節拍整合節點
    And 某檔案的偵測 BPM 為 280（可能是 140 的雙速）
    When 使用者點擊 BPM 值旁的「÷2」按鈕
    Then BPM 值更新為 140
    And 顯示「已半速修正」標記

  # ============================================
  # Scenario 5: 目標 BPM 設定
  # ============================================
  Scenario: 預設目標 BPM
    Given 使用者已建立一個節拍整合節點
    And 已連接多個音訊來源
    When BPM 分析完成
    Then 預設目標 BPM 為所有檔案的平均 BPM（四捨五入至整數）

  Scenario: 使用預設 BPM 模式
    Given 使用者已建立一個節拍整合節點
    Then 節點提供預設目標 BPM 模式選項
    And 選項包含「平均值」模式（所有檔案 BPM 平均值）
    And 選項包含「最常見」模式（最多檔案的 BPM 值）
    And 選項包含「最小值」模式（最慢的 BPM）
    And 選項包含「最大值」模式（最快的 BPM）
    And 選項包含「自訂」模式

  Scenario: 自訂目標 BPM
    Given 使用者已建立一個節拍整合節點
    When 使用者選擇「自訂」模式
    Then 顯示 BPM 輸入欄位
    And 使用者可輸入目標 BPM（40 至 240 BPM）

  Scenario: 使用滑桿調整目標 BPM
    Given 使用者已建立一個節拍整合節點
    And 使用者選擇「自訂」模式
    When 使用者拖曳 BPM 滑桿
    Then 目標 BPM 即時更新
    And 顯示預估調整後各檔案的速度變化百分比
    And 顯示調整後的音訊時長變化

  Scenario: 快速設定常用 BPM 值
    Given 使用者已建立一個節拍整合節點
    Then 節點顯示常用 BPM 快速選擇按鈕
    And 提供 60, 90, 120, 140, 160, 180 BPM 等選項
    When 使用者點擊任一快速選擇按鈕
    Then 目標 BPM 立即設定為該值

  # ============================================
  # Scenario 6: 執行節拍整合
  # ============================================
  Scenario: 按下執行按鈕開始整合
    Given 使用者已建立一個節拍整合節點
    And 已連接多個音訊來源
    And 已設定目標 BPM
    When 使用者按下「執行」按鈕
    Then 顯示處理中狀態
    And 顯示處理進度條
    And 進度條顯示已處理的檔案數量

  Scenario: 成功完成節拍整合
    Given 使用者已建立一個節拍整合節點
    And 已連接多個音訊來源
    And 已按下「執行」按鈕
    When 處理完成
    Then 顯示「處理完成」提示
    And 所有輸出音訊的 BPM 統一為目標值
    And 輸出連接點可傳遞處理後的音訊
    And 音高保持不變

  Scenario: 節拍整合保持相對速度關係
    Given 使用者已建立一個節拍整合節點
    And 已連接多個音訊來源
    And 勾選「保持相對節拍」選項
    When 使用者按下「執行」按鈕
    Then 所有檔案同比例調整速度
    And 原本較快的檔案處理後仍較快（相對關係不變）
    And 基準檔案調整至目標 BPM，其餘同比例調整

  Scenario: 節拍整合使用絕對 BPM 模式
    Given 使用者已建立一個節拍整合節點
    And 已連接多個音訊來源
    And 未勾選「保持相對節拍」選項
    When 使用者按下「執行」按鈕
    Then 每個檔案獨立調整至目標 BPM
    And 處理後所有檔案的 BPM 完全一致

  Scenario: 顯示處理警告（速度變化過大）
    Given 使用者已建立一個節拍整合節點
    And 某檔案的 BPM 為 60
    And 目標 BPM 設定為 180（3 倍速）
    When 使用者按下「執行」按鈕
    Then 顯示警告訊息「速度變化超過 2 倍，音質可能下降」
    And 提供「繼續處理」或「取消」選項

  # ============================================
  # Scenario 7: 音質設定
  # ============================================
  Scenario: 選擇時間伸縮演算法品質
    Given 使用者已建立一個節拍整合節點
    Then 節點提供音質設定選項
    And 選項包含「快速」模式（處理速度快，音質普通）
    And 選項包含「標準」模式（平衡速度與音質，預設）
    And 選項包含「高品質」模式（處理較慢，音質最佳）

  Scenario: 變更音質設定
    Given 使用者已建立一個節拍整合節點
    When 使用者選擇「高品質」模式
    Then 處理時使用高品質時間伸縮演算法
    And 顯示預估處理時間會增加

  # ============================================
  # Scenario 8: 預覽區域顯示
  # ============================================
  Scenario: 展開預覽頁簽
    Given 使用者已建立一個節拍整合節點
    And 已連接多個音訊來源
    And 已完成節拍整合處理
    When 展開節拍整合節點的預覽頁簽
    Then 顯示處理後的多檔案預覽區域
    And 每個預覽區域顯示檔案名稱
    And 每個預覽區域顯示處理後的音訊波形圖
    And 每個預覽區域可獨立播放

  Scenario: 預覽區域顯示 BPM 變化
    Given 使用者已建立一個節拍整合節點
    And 已完成節拍整合處理
    When 展開預覽頁簽
    Then 每個預覽區域顯示處理前後的 BPM 變化
    And 顯示變化值（如「120 → 140 BPM」）
    And 顯示速度變化百分比（如「+16.7%」）
    And 顯示時長變化（如「3.5s → 3.0s」）

  Scenario: 多檔案預覽分頁功能
    Given 使用者已建立一個節拍整合節點
    And 已連接超過 5 個音訊來源
    And 已完成節拍整合處理
    When 展開預覽頁簽
    Then 預覽區域每頁最多顯示 5 個檔案
    And 顯示分頁資訊
    And 可透過分頁按鈕切換檢視

  Scenario: 預覽處理前後對比播放
    Given 使用者已建立一個節拍整合節點
    And 已完成節拍整合處理
    When 展開預覽頁簽
    Then 每個檔案提供「播放原始」和「播放處理後」按鈕
    And 可切換播放處理前後的版本
    And 顯示當前播放的版本標示

  # ============================================
  # Scenario 9: 輸出連接
  # ============================================
  Scenario: 節拍整合節點連接到下游處理節點
    Given 使用者已建立一個節拍整合節點
    And 節拍整合節點已完成處理
    When 使用者將節拍整合節點的輸出連接到其他處理節點
    Then 連線成功建立
    And 下游節點接收到所有整合後的音訊檔案
    And 下游節點顯示多檔案預覽

  # ============================================
  # Scenario 10: 下載功能
  # ============================================
  Scenario: 下載全部處理後的檔案
    Given 使用者已建立一個節拍整合節點
    And 節拍整合節點已完成處理
    When 按下「下載全部」按鈕
    Then 所有處理後的音訊檔案被打包成 ZIP 壓縮檔
    And 自動下載該壓縮檔
    And 壓縮檔內的檔案保留原始檔名並加上 BPM 標記（如 「sound_140bpm.wav」）

  Scenario: 下載單一處理後的檔案
    Given 使用者已建立一個節拍整合節點
    And 節拍整合節點已完成處理
    When 按下單一檔案的「下載」按鈕
    Then 僅下載該處理後的檔案（WAV 格式）
    And 檔案名稱保留原始檔名並加上 BPM 標記

  # ============================================
  # Scenario 11: 錯誤處理
  # ============================================
  Scenario: 沒有任何輸入時顯示提示
    Given 使用者已建立一個節拍整合節點
    And 沒有任何輸入連接
    Then 節點顯示「請連接音訊來源」提示
    And 「執行」按鈕為禁用狀態

  Scenario: BPM 偵測失敗的處理
    Given 使用者已建立一個節拍整合節點
    And 已連接音訊來源
    And 某檔案的 BPM 無法偵測（如：白噪音、純音調）
    When BPM 分析完成
    Then 該檔案顯示「無法偵測 BPM」標記
    And 提供手動輸入 BPM 選項
    And 該檔案預設不參與自動整合

  Scenario: BPM 信心度過低的警告
    Given 使用者已建立一個節拍整合節點
    And 已連接音訊來源
    And 某檔案的 BPM 信心度低於 60%
    When BPM 分析完成
    Then 該檔案顯示「⚠ 低信心度」警告標記
    And 建議使用者手動確認或修正 BPM 值

  Scenario: 只有一個輸入檔案時的處理
    Given 使用者已建立一個節拍整合節點
    And 已連接 1 個音訊來源
    When 使用者按下「執行」按鈕
    Then 系統正常處理該檔案
    And 輸出音訊調整至目標 BPM
    And 顯示「已完成節拍調整」提示

  Scenario: 未按執行時禁止輸出
    Given 使用者已建立一個節拍整合節點
    And 已連接多個音訊來源
    And 尚未按下「執行」按鈕
    Then 輸出連接點顯示為待處理狀態
    And 無法將輸出連接到下游節點
    And 顯示「請先按執行按鈕處理音訊」提示

  Scenario: 重新連接輸入後需重新執行
    Given 使用者已建立一個節拍整合節點
    And 已完成節拍整合處理
    When 使用者變更輸入連接（新增或移除音訊來源）
    Then 節點顯示「輸入已變更，請重新執行」提示
    And 之前的處理結果失效
    And 需重新分析 BPM
    And 需重新按下「執行」按鈕

  Scenario: 音訊過長導致處理時間較久的提示
    Given 使用者已建立一個節拍整合節點
    And 已連接音訊來源
    And 某檔案時長超過 5 分鐘
    When 使用者按下「執行」按鈕
    Then 顯示提示訊息「檔案較大，處理可能需要較長時間」
    And 顯示預估處理時間
    And 提供「在背景處理」選項
