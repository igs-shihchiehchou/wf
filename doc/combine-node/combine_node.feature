# language: zh-TW
Feature: Combine Node（合併節點）
  作為 使用者
  我希望 可以將多個音訊輸入合併成一個列表
  以便 統一管理並進行批次處理

  Background:
    Given 使用者已開啟音效編輯工具
    And 工具列中有「合併節點」可供新增

  # ============================================
  # Scenario 1: 建立合併節點
  # ============================================
  Scenario: 成功建立合併節點
    When 使用者從工具列拖拉或點擊新增「合併節點」
    Then 畫布上出現一個合併節點
    And 節點預設有 2 個輸入連接點
    And 節點有 1 個輸出連接點
    And 節點底部顯示「+」按鈕

  # ============================================
  # Scenario 2: 動態新增輸入點
  # ============================================
  Scenario: 點擊「+」按鈕新增輸入點
    Given 使用者已建立一個合併節點
    And 節點目前有 2 個輸入連接點
    When 使用者點擊節點底部的「+」按鈕
    Then 節點新增一個輸入連接點
    And 節點目前有 3 個輸入連接點
    And 新的輸入連接點可接受連線

  Scenario: 連續新增多個輸入點
    Given 使用者已建立一個合併節點
    When 使用者點擊「+」按鈕 3 次
    Then 節點共有 5 個輸入連接點
    And 所有輸入連接點皆可接受連線

  # ============================================
  # Scenario 3: 移除輸入點
  # ============================================
  Scenario: 移除未連接的輸入點
    Given 使用者已建立一個合併節點
    And 節點目前有 3 個輸入連接點
    And 第 3 個輸入點沒有連線
    When 使用者點擊第 3 個輸入點的移除按鈕
    Then 第 3 個輸入點被移除
    And 節點目前有 2 個輸入連接點

  Scenario: 無法移除已連接的輸入點
    Given 使用者已建立一個合併節點
    And 第 2 個輸入點已連接音訊來源
    When 使用者嘗試移除第 2 個輸入點
    Then 顯示提示訊息「請先移除連線再刪除輸入點」
    And 輸入點不會被移除

  Scenario: 無法減少至少於 2 個輸入點
    Given 使用者已建立一個合併節點
    And 節點目前有 2 個輸入連接點
    Then 移除按鈕不可用或隱藏
    And 使用者無法移除任何輸入點

  # ============================================
  # Scenario 4: 連接音訊來源
  # ============================================
  Scenario: 連接單一音訊輸入節點
    Given 使用者已建立一個合併節點
    And 使用者已建立一個音訊輸入節點並載入檔案
    When 使用者將音訊輸入節點的輸出連接到合併節點的第 1 個輸入
    Then 連線成功建立
    And 合併節點顯示已連接 1 個來源

  Scenario: 連接多個音訊輸入節點
    Given 使用者已建立一個合併節點
    And 使用者已建立 3 個音訊輸入節點並各載入檔案
    When 使用者將 3 個音訊輸入節點分別連接到合併節點的輸入
    Then 所有連線成功建立
    And 合併節點顯示已連接 3 個來源

  Scenario: 連接處理節點的輸出
    Given 使用者已建立一個合併節點
    And 使用者已建立音訊輸入節點 → 音量調整節點的流程
    When 使用者將音量調整節點的輸出連接到合併節點的輸入
    Then 連線成功建立
    And 合併節點可接收處理過的音訊

  # ============================================
  # Scenario 5: 合併多檔案來源
  # ============================================
  Scenario: 合併來自多檔案輸入節點的音訊
    Given 使用者已建立一個合併節點
    And 使用者已建立一個音訊輸入節點並載入 3 個檔案
    And 使用者已建立另一個音訊輸入節點並載入 2 個檔案
    When 使用者將兩個音訊輸入節點連接到合併節點
    Then 合併節點的輸出包含 5 個音訊檔案
    And 保留所有原始檔案名稱

  # ============================================
  # Scenario 6: 預覽區域顯示
  # ============================================
  Scenario: 合併節點顯示多檔案預覽
    Given 使用者已建立一個合併節點
    And 已連接多個音訊來源（共 4 個檔案）
    When 展開合併節點的預覽頁簽
    Then 顯示所有合併後的檔案預覽
    And 每個預覽區域顯示檔案名稱
    And 每個預覽區域顯示音訊波形圖
    And 每個預覽區域可獨立播放

  Scenario: 合併節點預覽分頁功能
    Given 使用者已建立一個合併節點
    And 已連接多個音訊來源（共超過 5 個檔案）
    When 展開合併節點的預覽頁簽
    Then 預覽區域每頁最多顯示 5 個檔案
    And 顯示分頁資訊
    And 可透過分頁按鈕切換檢視

  # ============================================
  # Scenario 7: 輸出連接
  # ============================================
  Scenario: 合併節點連接到處理節點
    Given 使用者已建立一個合併節點
    And 合併節點已連接多個音訊來源
    When 使用者將合併節點的輸出連接到音量調整節點
    Then 連線成功建立
    And 音量調整節點接收到所有合併的音訊檔案
    And 音量調整節點顯示多檔案預覽

  # ============================================
  # Scenario 7-1: 預覽區域單一檔案輸出連結點
  # ============================================
  Scenario: 多檔案預覽區域顯示單一輸出連結點
    Given 使用者已建立一個處理節點（如合併節點、音量調整節點等）
    And 節點已連接多個音訊來源
    When 展開節點的預覽頁簽
    Then 每個檔案預覽項目右側顯示一個輸出連結點
    And 連結點可用於建立連線

  Scenario: 從預覽區域單一檔案建立連線
    Given 使用者已建立一個處理節點
    And 節點已連接多個音訊來源
    And 預覽頁簽已展開
    When 使用者從某個檔案預覽項目的輸出連結點拖拉連線到下游節點
    Then 連線成功建立
    And 下游節點僅接收該單一檔案
    And 下游節點顯示單一檔案預覽

  Scenario: 多個單一檔案輸出連結點可分別連接
    Given 使用者已建立一個處理節點
    And 節點已連接 3 個音訊檔案
    And 預覽頁簽已展開
    When 使用者將檔案 1 的輸出連結點連接到音量調整節點 A
    And 使用者將檔案 2 的輸出連結點連接到音量調整節點 B
    Then 兩條連線皆成功建立
    And 音量調整節點 A 僅處理檔案 1
    And 音量調整節點 B 僅處理檔案 2

  # ============================================
  # Scenario 7-2: 有連線時預覽區域鎖定
  # ============================================
  Scenario: 預覽區域有輸出連線時無法收縮
    Given 使用者已建立一個處理節點
    And 節點已連接多個音訊來源
    And 預覽頁簽已展開
    And 某個檔案預覽項目的輸出連結點已建立連線
    When 使用者嘗試收縮預覽頁簽
    Then 預覽頁簽無法收縮
    And 收縮按鈕顯示為禁用狀態或隱藏
    And 顯示提示「有輸出連線時無法收縮」

  Scenario: 移除所有輸出連線後可收縮預覽區域
    Given 使用者已建立一個處理節點
    And 預覽頁簽已展開且有輸出連線
    When 使用者移除所有從預覽區域建立的輸出連線
    Then 收縮按鈕恢復為可用狀態
    And 使用者可正常收縮預覽頁簽

  Scenario: 分頁切換時保持連線狀態
    Given 使用者已建立一個處理節點
    And 節點已連接超過 5 個音訊檔案
    And 第 1 頁的某個檔案已建立輸出連線
    When 使用者切換到第 2 頁
    Then 連線仍然有效
    And 切換回第 1 頁時連線正常顯示

  # ============================================
  # Scenario 8: 下載功能
  # ============================================
  Scenario: 合併節點下載全部檔案
    Given 使用者已建立一個合併節點
    And 合併節點已連接多個音訊來源
    When 按下「下載全部」按鈕
    Then 所有音訊檔案被打包成 ZIP 壓縮檔
    And 自動下載該壓縮檔

  Scenario: 合併節點下載單一檔案
    Given 使用者已建立一個合併節點
    And 合併節點已連接多個音訊來源
    When 按下單一檔案的「下載」按鈕
    Then 僅下載該檔案（WAV 格式）

  # ============================================
  # Scenario 9: 輸入順序管理
  # ============================================
  Scenario: 合併後的檔案順序依照輸入點順序
    Given 使用者已建立一個合併節點
    And 輸入點 1 連接的檔案為 A.wav
    And 輸入點 2 連接的檔案為 B.wav
    And 輸入點 3 連接的檔案為 C.wav
    Then 合併後的檔案順序為 A.wav, B.wav, C.wav

  Scenario: 多檔案輸入的內部順序保持
    Given 使用者已建立一個合併節點
    And 輸入點 1 連接的多檔案為 A1.wav, A2.wav
    And 輸入點 2 連接的多檔案為 B1.wav, B2.wav
    Then 合併後的檔案順序為 A1.wav, A2.wav, B1.wav, B2.wav

  # ============================================
  # Scenario 10: 錯誤處理
  # ============================================
  Scenario: 沒有任何輸入時顯示提示
    Given 使用者已建立一個合併節點
    And 沒有任何輸入連接
    Then 節點顯示「請連接音訊來源」提示
    And 輸出不產生任何資料

  Scenario: 部分輸入未連接
    Given 使用者已建立一個合併節點
    And 節點有 3 個輸入點
    And 只有輸入點 1 和 3 有連接
    Then 合併節點正常運作
    And 僅輸出已連接的音訊來源
